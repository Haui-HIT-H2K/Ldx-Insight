name: Deploy Backend to EC2

on:
  push:
    branches:
      - main # (Hoáº·c 'master')

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # --- CÃC BÆ¯á»šC 1-3 GIá»® NGUYÃŠN ---
      - name: 1. Checkout code
        uses: actions/checkout@v4

      - name: 2. Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "corretto"

      - name: 3. Build project with Maven
        run: mvn clean package -DskipTests
        working-directory: ./backend/ldx-insight-backend

      # ðŸ’¡ Sá»¬A Lá»–I á»ž BÆ¯á»šC 4
      - name: 4. Copy deploy files to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          port: 22
          # Copy 2 file: file JAR VÃ€ ká»‹ch báº£n deploy
          source: |
            backend/ldx-insight-backend/target/ldx-insight-backend-*.jar
            scripts/deploy.sh
          target: "/home/${{ secrets.EC2_USERNAME }}/app"

      # ðŸ’¡ Sá»¬A Lá»–I á»ž BÆ¯á»šC 5
      - name: 5. Run deploy script on EC2 (An toÃ n)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          port: 22
          # Chá»‰ cháº¡y ká»‹ch báº£n deploy.sh trong ná»n
          script: |
            # 1. Di chuyá»ƒn vÃ o thÆ° má»¥c á»©ng dá»¥ng
            cd /home/${{ secrets.EC2_USERNAME }}/app

            # 2. Cáº¥p quyá»n thá»±c thi cho ká»‹ch báº£n
            chmod +x deploy.sh

            # 3. Cháº¡y ká»‹ch báº£n trong NOHUP (tÃ¡ch biá»‡t khá»i SSH)
            # Ghi log cá»§a ká»‹ch báº£n nÃ y ra file deploy.log
            nohup bash deploy.sh > deploy.log 2>&1 &
